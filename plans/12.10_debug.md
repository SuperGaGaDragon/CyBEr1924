
# Bug æŠ¥å‘Šå’Œè§£å†³æ–¹æ¡ˆ - 2025-12-10

## âŒ CRITICAL: 401 è®¤è¯é—®é¢˜ï¼ˆå†æ¬¡å‡ºç°ï¼‰

### é—®é¢˜ç°è±¡
ç”¨æˆ·åœ¨å·²ç™»å½•çš„æƒ…å†µä¸‹ï¼Œè®¿é—® session é¡µé¢æ—¶æ”¶åˆ° `401 Unauthorized` é”™è¯¯ï¼š
```json
{"detail":"Not authenticated"}
```

**å—å½±å“çš„ Session**: `sess-20251210-204413-3b9a091d`

### æ ¹æœ¬åŸå› åˆ†æ

#### ğŸ” è®¤è¯æµç¨‹å›é¡¾

1. **ç™»å½•æµç¨‹** ([App.tsx:1218-1248](multi_agent_platform/ui/src/App.tsx#L1218-L1248)):
   ```typescript
   // ç™»å½•æˆåŠŸåä¿å­˜ token
   localStorage.setItem("cyber1924_token", resp.access_token);
   setAccessToken(resp.access_token);  // è®¾ç½®å†…å­˜ä¸­çš„ token
   ```

2. **åˆå§‹åŒ–æµç¨‹** ([App.tsx:1023-1033](multi_agent_platform/ui/src/App.tsx#L1023-L1033)):
   ```typescript
   // é¡µé¢åŠ è½½æ—¶ä» localStorage æ¢å¤ token
   useEffect(() => {
     const savedToken = localStorage.getItem("cyber1924_token");
     if (savedToken) {
       setAccessToken(savedToken);  // âœ… æ¢å¤åˆ°å†…å­˜
       setAuth((prev) => ({ ...prev, accessToken: savedToken, isLoggedIn: true }));
     }
   }, []);
   ```

3. **è¯·æ±‚å‘é€** ([api.ts:144-146](multi_agent_platform/ui/src/api.ts#L144-L146)):
   ```typescript
   // æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¸¦ä¸Š Authorization header
   if (accessToken) {
     headers["Authorization"] = `Bearer ${accessToken}`;
   }
   ```

4. **åç«¯éªŒè¯** ([api.py:109-128](api.py#L109-L128)):
   ```python
   def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security)):
       if credentials is None:
           raise HTTPException(status_code=401, detail="Not authenticated")

       token = credentials.credentials
       user_id = decode_access_token(token)
       if not user_id:
           raise HTTPException(status_code=401, detail="Invalid or expired token")
   ```

#### ğŸ› å¯èƒ½çš„å¤±è´¥åœºæ™¯

**åœºæ™¯ A: Token è¿‡æœŸ**
- JWT token æœ‰æœ‰æ•ˆæœŸé™åˆ¶
- å¦‚æœç”¨æˆ·ç™»å½•åå¾ˆé•¿æ—¶é—´ï¼ˆä¾‹å¦‚å‡ å¤©ï¼‰å†è®¿é—®ï¼Œtoken å¯èƒ½å·²è¿‡æœŸ
- **ç—‡çŠ¶**: `decode_access_token()` è¿”å› `None`ï¼Œåç«¯è¿”å› "Invalid or expired token"

**åœºæ™¯ B: Token æœªæ­£ç¡®æ¢å¤**
- é¡µé¢åˆ·æ–°æ—¶ `useEffect` æœªæ­£ç¡®æ‰§è¡Œ
- `setAccessToken()` è°ƒç”¨å¤±è´¥æˆ–å»¶è¿Ÿ
- **ç—‡çŠ¶**: è¯·æ±‚æ—¶ `accessToken` ä¸º `null`ï¼Œä¸å¸¦ Authorization headerï¼Œåç«¯è¿”å› "Not authenticated"

**åœºæ™¯ C: è·¨åŸŸ Token ä¸¢å¤±**
- å¦‚æœä»ä¸åŒåŸŸåè®¿é—®ï¼ˆä¾‹å¦‚ Railway é¢„è§ˆ URLï¼‰
- localStorage å¯èƒ½æ— æ³•è®¿é—®ä¹‹å‰çš„ token
- **ç—‡çŠ¶**: ç”¨æˆ·çœ‹èµ·æ¥å·²ç™»å½•ï¼Œä½†å®é™…ä¸Š token å·²ä¸¢å¤±

**åœºæ™¯ D: Token æ ¼å¼é”™è¯¯**
- Token åœ¨å­˜å‚¨/è¯»å–è¿‡ç¨‹ä¸­è¢«æŸå
- åŒ…å«é¢å¤–çš„ç©ºæ ¼æˆ–æ¢è¡Œç¬¦
- **ç—‡çŠ¶**: åç«¯æ— æ³•è§£ç  token

### è¯Šæ–­æ­¥éª¤

#### Step 1: æ£€æŸ¥æµè§ˆå™¨ DevTools

1. **æ‰“å¼€ Console æ ‡ç­¾**ï¼Œåˆ·æ–°é¡µé¢ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯
2. **æ‰“å¼€ Application æ ‡ç­¾** â†’ Local Storage:
   - æ£€æŸ¥ `cyber1924_token` æ˜¯å¦å­˜åœ¨
   - å¤åˆ¶ token å€¼ï¼Œæ£€æŸ¥æ˜¯å¦å®Œæ•´ï¼ˆJWT æ ¼å¼ï¼š`xxx.yyy.zzz`ï¼‰
3. **æ‰“å¼€ Network æ ‡ç­¾**ï¼Œå°è¯•è®¿é—® session:
   - æ‰¾åˆ°å¤±è´¥çš„ `/sessions/sess-xxx` è¯·æ±‚
   - **æŸ¥çœ‹ Request Headers**:
     - æ˜¯å¦æœ‰ `Authorization: Bearer xxx` headerï¼Ÿ
     - Token å€¼æ˜¯å¦ä¸ localStorage ä¸­ä¸€è‡´ï¼Ÿ
   - **æŸ¥çœ‹ Response**:
     - è¿”å›çš„é”™è¯¯æ˜¯ "Not authenticated" è¿˜æ˜¯ "Invalid or expired token"ï¼Ÿ

#### Step 2: éªŒè¯ Token æœ‰æ•ˆæ€§

æ‰“å¼€æµè§ˆå™¨ Consoleï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š

```javascript
// 1. æ£€æŸ¥ localStorage
console.log("Token in localStorage:", localStorage.getItem("cyber1924_token"));

// 2. æ‰‹åŠ¨æµ‹è¯• API è°ƒç”¨
const token = localStorage.getItem("cyber1924_token");
fetch("https://cyber1924-production.up.railway.app/sessions", {
  headers: {
    "Authorization": `Bearer ${token}`
  }
})
.then(r => r.json())
.then(data => console.log("API Response:", data))
.catch(err => console.error("API Error:", err));
```

**é¢„æœŸç»“æœ**:
- å¦‚æœ token æœ‰æ•ˆ â†’ è¿”å› session åˆ—è¡¨
- å¦‚æœ token è¿‡æœŸ â†’ `{"detail":"Invalid or expired token"}`
- å¦‚æœ token ä¸¢å¤± â†’ `{"detail":"Not authenticated"}`

#### Step 3: æ£€æŸ¥åç«¯æ—¥å¿—

åœ¨ Railway æ§åˆ¶å°æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—ï¼š
```bash
# æœç´¢è®¤è¯ç›¸å…³çš„é”™è¯¯
# æŸ¥æ‰¾ session_id: sess-20251210-204413-3b9a091d
# æŸ¥æ‰¾ç”¨æˆ· ID å’Œ token è§£ç å¤±è´¥çš„è®°å½•
```

### ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ A: é‡æ–°ç™»å½•**
1. ç‚¹å‡» "Logout" æŒ‰é’®
2. é‡æ–°è¾“å…¥é‚®ç®±å’Œå¯†ç ç™»å½•
3. å°è¯•è®¿é—®ä¹‹å‰å¤±è´¥çš„ session

**æ–¹æ¡ˆ B: æ¸…é™¤ localStorage**
```javascript
// åœ¨æµè§ˆå™¨ Console æ‰§è¡Œ
localStorage.clear();
location.reload();
```

### æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

#### è§£å†³æ–¹æ¡ˆ 1: æ·»åŠ  Token åˆ·æ–°æœºåˆ¶

**ç›®æ ‡**: Token è¿‡æœŸå‰è‡ªåŠ¨åˆ·æ–°

**å®æ–½ä½ç½®**: [api.py](api.py)

æ·»åŠ  `/auth/refresh` endpoint:
```python
@app.post("/auth/refresh")
def refresh_token(current_user = Depends(get_current_user)) -> AuthResponse:
    """
    åˆ·æ–° access tokenã€‚
    éœ€è¦æä¾›æœ‰æ•ˆçš„å½“å‰ tokenã€‚
    """
    new_token = create_access_token(current_user.id)
    return AuthResponse(
        message="Token refreshed",
        access_token=new_token,
        token_type="bearer"
    )
```

å‰ç«¯åœ¨æ£€æµ‹åˆ° 401 é”™è¯¯æ—¶è‡ªåŠ¨å°è¯•åˆ·æ–°:
```typescript
// api.ts
async function request<T>(path: string, options: RequestInit = {}): Promise<T> {
  const resp = await fetch(`${API_BASE}${path}`, { ...options, headers });

  if (resp.status === 401 && path !== "/auth/refresh") {
    // Token å¯èƒ½è¿‡æœŸï¼Œå°è¯•åˆ·æ–°
    try {
      const refreshResp = await fetch(`${API_BASE}/auth/refresh`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${accessToken}` }
      });
      if (refreshResp.ok) {
        const data = await refreshResp.json();
        setAccessToken(data.access_token);
        localStorage.setItem("cyber1924_token", data.access_token);
        // é‡è¯•åŸå§‹è¯·æ±‚
        return request<T>(path, options);
      }
    } catch {}
    // åˆ·æ–°å¤±è´¥ï¼ŒæŠ›å‡º 401 é”™è¯¯
  }

  // ... ç°æœ‰é”™è¯¯å¤„ç†é€»è¾‘
}
```

**é¢„æœŸæ—¶é—´**: 1-2 å°æ—¶
**é£é™©è¯„ä¼°**: ä¸­ï¼ˆéœ€è¦ä»”ç»†æµ‹è¯•åˆ·æ–°é€»è¾‘ï¼Œé¿å…æ— é™å¾ªç¯ï¼‰

#### è§£å†³æ–¹æ¡ˆ 2: å»¶é•¿ Token æœ‰æ•ˆæœŸ

**ç›®æ ‡**: è®© token æœ‰æ•ˆæœŸæ›´é•¿ï¼Œå‡å°‘è¿‡æœŸé¢‘ç‡

**å®æ–½ä½ç½®**: [api.py](api.py) - `create_access_token()` å‡½æ•°

```python
def create_access_token(user_id: int) -> str:
    # ä» 1 å°æ—¶å»¶é•¿åˆ° 7 å¤©
    expire = datetime.utcnow() + timedelta(days=7)
    payload = {
        "sub": str(user_id),
        "exp": expire,
    }
    return jwt.encode(payload, JWT_SECRET_KEY, algorithm="HS256")
```

**ä¼˜ç‚¹**: ç®€å•ï¼Œç«‹å³ç”Ÿæ•ˆ
**ç¼ºç‚¹**: å®‰å…¨æ€§é™ä½ï¼ˆtoken æ³„éœ²åæœ‰æ•ˆæœŸæ›´é•¿ï¼‰

**é¢„æœŸæ—¶é—´**: 5 åˆ†é’Ÿ
**é£é™©è¯„ä¼°**: ä½ï¼ˆçº¯é…ç½®ä¿®æ”¹ï¼‰

#### è§£å†³æ–¹æ¡ˆ 3: æ·»åŠ è¯¦ç»†çš„è®¤è¯é”™è¯¯æ—¥å¿—

**ç›®æ ‡**: å¸®åŠ©è¯Šæ–­æœªæ¥çš„è®¤è¯é—®é¢˜

**å®æ–½ä½ç½®**: [api.py:109-128](api.py#L109-L128)

```python
def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
):
    if credentials is None:
        print("[AUTH] No credentials provided")
        raise HTTPException(status_code=401, detail="Not authenticated")

    token = credentials.credentials
    print(f"[AUTH] Attempting to decode token: {token[:20]}...")  # åªæ‰“å°å‰20ä¸ªå­—ç¬¦

    user_id = decode_access_token(token)
    if not user_id:
        print(f"[AUTH] Token decode failed or expired")
        raise HTTPException(status_code=401, detail="Invalid or expired token")

    user = get_user_by_id(user_id)
    if not user:
        print(f"[AUTH] User {user_id} not found in database")
        raise HTTPException(status_code=401, detail="User not found")

    print(f"[AUTH] âœ“ User {user.id} authenticated successfully")
    return user
```

**é¢„æœŸæ—¶é—´**: 15 åˆ†é’Ÿ
**é£é™©è¯„ä¼°**: æä½ï¼ˆåªæ·»åŠ æ—¥å¿—ï¼‰

### å»ºè®®ä¼˜å…ˆçº§

1. **ç«‹å³**: è§£å†³æ–¹æ¡ˆ 3 - æ·»åŠ è®¤è¯æ—¥å¿—ï¼ˆå¸®åŠ©è¯Šæ–­å½“å‰é—®é¢˜ï¼‰
2. **çŸ­æœŸ**: è§£å†³æ–¹æ¡ˆ 2 - å»¶é•¿ token æœ‰æ•ˆæœŸï¼ˆå¿«é€Ÿä¿®å¤ï¼‰
3. **é•¿æœŸ**: è§£å†³æ–¹æ¡ˆ 1 - å®ç° token åˆ·æ–°æœºåˆ¶ï¼ˆæœ€ä½³å®è·µï¼‰

---

## å½“å‰çŠ¶æ€æ¦‚è§ˆ

### å·²ç¡®è®¤çš„é—®é¢˜
- âŒ **P0 - 401 è®¤è¯é”™è¯¯**: ç”¨æˆ·ç™»å½•åä»ç„¶æ”¶åˆ° "Not authenticated" é”™è¯¯
- Reviewer ä¸æ»šåŠ¨
- task 3åŠ è½½ä¸å‡ºæ¥ï¼Œå¡ç€ä¸æ˜¾ç¤º
- task 3 ä¸ä¼šæ‰§è¡Œã€‚
- è·³è¿‡task 3ï¼Œç›´æ¥ç”Ÿæˆtask1-4 summary
- task 4 åªæœ‰task 1-4 summaryï¼Œä¸æ‰§è¡Œç« èŠ‚åˆ†é…
- ä¸€æ—¦è¿›å…¥è¿™ä¸ªpageï¼Œreviewerå°±ä¸èƒ½æ»šåŠ¨

### ä¸€äº›å»ºè®®ï¼ˆå¯èƒ½ä¸å¯¹ï¼‰
- å»ºè®®å¼ºåˆ¶worker çš„outputå°±æ˜¯task 1ï¼Œtask2ï¼Œtask3ï¼Œtask4. è¿™ä¸ªsummaryé™„å±äºtask4ï¼Œä¸è¦å•ç‹¬å¼„ä¸€ä¸ªå•ç‹¬çš„å‡ºæ¥ï¼Œä¼šconfuseã€‚

---

## âŒâŒâŒ CRITICAL ISSUE: Novel Mode T3ä¸æ‰§è¡Œ & T4æ··ä¹±é—®é¢˜

### ç”¨æˆ·åé¦ˆçš„çœŸå®é—®é¢˜

**ç”¨æˆ·åŸè¯**: "è¿™æ˜æ˜¾å°±ä¸æ˜¯è¿™ä¹ˆç®€å•çš„é—®é¢˜ï¼Œå¦‚æœçœŸæ˜¯è¿™ä¹ˆç®€å•æ—©å°±è§£å†³äº†ã€‚ä½ è‡ªå·±çœ‹çœ‹é‚£å‡ ä¸ªä¸‰å››åƒè¡Œçš„tsxæ–‡ä»¶ï¼Œé‡Œé¢è·³è½¬éƒ½æœ‰é—®é¢˜ï¼Œè€Œä¸”ç”Ÿæˆçš„ä¸œè¥¿æ€ä¹ˆå¯èƒ½æ˜¯summaryï¼Œä»–ç”Ÿæˆçš„éƒ½ä¸æ˜¯task4ï¼Œæ˜¯summaryï¼åº”è¯¥æ˜¯task4 åŒ…å«summary å’Œ ç« èŠ‚åˆ†é…ä¸¤ä¸ªå†…å®¹ï¼Œæ˜ç™½å—ï¼Ÿ"

### é—®é¢˜ç—‡çŠ¶ï¼ˆç”¨æˆ·æŠ¥å‘Šï¼‰

1. **Task 3 åŠ è½½ä¸å‡ºæ¥ï¼Œå¡ç€ä¸æ˜¾ç¤º**
2. **Task 3 ä¸ä¼šæ‰§è¡Œ**
3. **è·³è¿‡ task 3ï¼Œç›´æ¥ç”Ÿæˆ task1-4 summary**
4. **Task 4 åªæœ‰ task 1-4 summaryï¼Œä¸æ‰§è¡Œç« èŠ‚åˆ†é…**
5. **ä¸€æ—¦è¿›å…¥è¿™ä¸ª pageï¼Œreviewer å°±ä¸èƒ½æ»šåŠ¨**

### æ ¹æœ¬åŸå› åˆ†æ

#### ğŸ” Novel Mode å·¥ä½œæµç¨‹

**é¢„æœŸçš„ Novel Mode æµç¨‹**:
```
T1: Research (ç ”ç©¶) â†’
T2: äººç‰©è®¾å®š (è§’è‰²) â†’
T3: æƒ…èŠ‚è®¾è®¡ (æƒ…èŠ‚) â†’
T4: ç« èŠ‚åˆ†é… & å°è¯´æ¦‚è¦æ’°å†™ (åŒ…å«ä¸¤éƒ¨åˆ†å†…å®¹ï¼)
  â”œâ”€ Part A: ç« èŠ‚åˆ†é… (Chapter Allocations)
  â””â”€ Part B: å°è¯´æ¦‚è¦ (Novel Synopsis)
```

**å®é™…å‘ç”Ÿçš„æƒ…å†µ**:
- T3 å¯èƒ½æ²¡æœ‰æ­£ç¡®æ‰§è¡Œ
- T4 åº”è¯¥åŒ…å«"ç« èŠ‚åˆ†é…"å’Œ"æ¦‚è¦æ’°å†™"ä¸¤ä¸ªéƒ¨åˆ†
- ä½†å‰ç«¯åªæ˜¾ç¤ºäº†"Novel Summary (t1-t4)"ï¼Œä¸¢å¤±äº† T4 çš„å…·ä½“å†…å®¹

#### ğŸ› ä»£ç åˆ†æ

##### 1. Plan Definition ([Plan JSON Example](multi_agent_platform/sessions/sess-20251209-150109-df2e85a9/artifacts/0f896a2d0c51.json#L38-L46))

```json
{
  "id": "t4",
  "title": "ç« èŠ‚åˆ†é… & å°è¯´æ¦‚è¦æ’°å†™",
  "description": "Produce chapter allocation and concise novel synopsis; include chapter-wise responsibilities.",
  "status": "pending"
}
```

**æ­£ç¡®**: T4 çš„ title æ˜ç¡®åŒ…å«ä¸¤ä¸ªä»»åŠ¡ã€‚

##### 2. Backend Summary Generation ([run_flow.py:307-373](multi_agent_platform/run_flow.py#L307-L373))

```python
def _update_novel_summary(state, plan, artifact_store):
    """Compute and cache t1-t4 summary for novel mode."""
    summary_lines: List[str] = []
    t4_chapter_allocations = None

    # éå† t1-t4
    for sub in plan.subtasks[:4]:
        content = getattr(sub, "output", "") or getattr(sub, "notes", "") or ""
        if content:
            summary_lines.append(f"{sub.id} {sub.title}: {content}")

            # âš ï¸ æå– t4 è¯¦ç»†å†…å®¹
            if sub.id == "t4":
                t4_chapter_allocations = content
                print(f"  [Novel Summary] Extracted t4 chapter allocations ({len(content)} chars)")

    summary = "\n".join(summary_lines).strip()
    state.extra["novel_summary_t1_t4"] = summary  # âœ… ä¿å­˜å®Œæ•´ summary

    # âœ… å•ç‹¬ä¿å­˜ t4 è¯¦ç»†å†…å®¹
    if t4_chapter_allocations:
        state.extra["t4_detailed_chapter_allocations"] = t4_chapter_allocations
```

**åˆ†æ**:
- âœ… åç«¯**æ­£ç¡®**æå–äº† t4 çš„å®Œæ•´å†…å®¹
- âœ… åç«¯**æ­£ç¡®**å°† t4 è¯¦ç»†å†…å®¹å•ç‹¬ä¿å­˜åˆ° `t4_detailed_chapter_allocations`
- â“ ä½†å‰ç«¯æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºäº†è¿™ä¸¤ä¸ªå­—æ®µï¼Ÿ

##### 3. Frontend Display - Worker Column ([App.tsx:3854](multi_agent_platform/ui/src/App.tsx#L3854))

```typescript
const novelSummary = (snapshot as any)?.state?.extra?.novel_summary_t1_t4 ||
                     (snapshot as any)?.orchestrator_state?.extra?.novel_summary_t1_t4;
```

**æ˜¾ç¤ºé€»è¾‘** ([App.tsx:4050-4060](multi_agent_platform/ui/src/App.tsx#L4050-L4060)):
```typescript
{novelSummary && (
  <div>
    <div style={{...}}>
      Novel Summary (t1â€“t4)  {/* âš ï¸ åªæ˜¾ç¤ºæ ‡é¢˜ï¼Œæ²¡æœ‰åŒºåˆ† t4 */}
    </div>
    <div style={{ whiteSpace: "pre-wrap" }}>{novelSummary}</div>
  </div>
)}
```

**é—®é¢˜**:
- âŒ Worker åˆ—åªæ˜¾ç¤º `novel_summary_t1_t4`
- âŒ æ²¡æœ‰å•ç‹¬æ˜¾ç¤º `t4_detailed_chapter_allocations`
- âŒ ç”¨æˆ·æ— æ³•åŒºåˆ†å“ªäº›æ˜¯ T4 çš„ä¸“å±å†…å®¹

##### 4. Frontend Display - Reviewer Column ([App.tsx:4171-4172](multi_agent_platform/ui/src/App.tsx#L4171-L4172))

```typescript
const novelSummary = (snapshot as any)?.state?.extra?.novel_summary_t1_t4 || ...;
const t4Details = (snapshot as any)?.state?.extra?.t4_detailed_chapter_allocations || ...;
```

**æ˜¾ç¤ºé€»è¾‘** ([App.tsx:4309-4314](multi_agent_platform/ui/src/App.tsx#L4309-L4314)):
```typescript
{novelSummary && (
  <div>
    <div>Novel Summary (t1â€“t4)</div>
    <div>{novelSummary}</div>
  </div>
)}
{t4Details && (
  // âš ï¸ è¿™é‡Œåº”è¯¥æœ‰æ˜¾ç¤º t4 è¯¦ç»†å†…å®¹çš„é€»è¾‘
  // ä½†éœ€è¦ç¡®è®¤æ˜¯å¦çœŸçš„æ¸²æŸ“äº†
)}
```

**é—®é¢˜**:
- â“ Reviewer åˆ—è™½ç„¶è¯»å–äº† `t4Details`ï¼Œä½†éœ€è¦ç¡®è®¤æ˜¯å¦æ­£ç¡®æ¸²æŸ“
- â“ å¯èƒ½ç¼ºå°‘å¯¹ `t4Details` çš„æ˜¾ç¤ºé€»è¾‘

##### 5. Worker Outputs Display ([App.tsx:3843-3846](multi_agent_platform/ui/src/App.tsx#L3843-L3846))

```typescript
const outputs = [...(snapshot?.worker_outputs ?? [])].sort((a, b) => {
  const diff = new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
  return descending ? -diff : diff;
});
```

**é—®é¢˜**:
- âŒ `worker_outputs` åº”è¯¥åŒ…å«æ¯ä¸ª subtask çš„ç‹¬ç«‹ output
- âŒ ä½†ç”¨æˆ·åæ˜  T3 æ²¡æœ‰æ˜¾ç¤ºï¼ŒT4 åªæ˜¾ç¤ºäº† summary
- â“ éœ€è¦ç¡®è®¤ï¼š`worker_outputs` æ•°ç»„ä¸­æ˜¯å¦çœŸçš„åŒ…å«äº† t3 å’Œ t4 çš„æ¡ç›®ï¼Ÿ

### è¯Šæ–­æ­¥éª¤

#### Step 1: æ£€æŸ¥ Session State

è®¿é—®ä¸€ä¸ªæœ‰é—®é¢˜çš„ sessionï¼Œåœ¨æµè§ˆå™¨ Console æ‰§è¡Œï¼š

```javascript
// 1. æ£€æŸ¥ snapshot æ•°æ®
console.log("Session snapshot:", window.__DEBUG_SNAPSHOT__);

// 2. æ£€æŸ¥ worker_outputs
const outputs = window.__DEBUG_SNAPSHOT__?.worker_outputs || [];
console.log("Worker outputs count:", outputs.length);
outputs.forEach((o, i) => {
  console.log(`Output ${i}: subtask_id=${o.subtask_id}, timestamp=${o.timestamp}`);
});

// 3. æ£€æŸ¥ extra å­—æ®µ
const extra = window.__DEBUG_SNAPSHOT__?.state?.extra ||
              window.__DEBUG_SNAPSHOT__?.orchestrator_state?.extra;
console.log("Extra fields:", Object.keys(extra || {}));
console.log("novel_summary_t1_t4:", extra?.novel_summary_t1_t4?.substring(0, 200));
console.log("t4_detailed_chapter_allocations:", extra?.t4_detailed_chapter_allocations?.substring(0, 200));

// 4. æ£€æŸ¥ subtasks çŠ¶æ€
const subtasks = window.__DEBUG_SNAPSHOT__?.subtasks || [];
subtasks.forEach(s => {
  console.log(`Subtask ${s.id}: status=${s.status}, title=${s.title}, has_output=${!!s.output}`);
});
```

**é¢„æœŸç»“æœ**:
- `worker_outputs` åº”è¯¥åŒ…å« t1, t2, t3, t4 çš„æ¡ç›®
- `extra.novel_summary_t1_t4` åº”è¯¥åŒ…å«æ‰€æœ‰ 4 ä¸ªä»»åŠ¡çš„å†…å®¹
- `extra.t4_detailed_chapter_allocations` åº”è¯¥åŒ…å« t4 çš„å®Œæ•´è¾“å‡º
- æ‰€æœ‰ subtasks çš„ status åº”è¯¥æ˜¯ "done"

#### Step 2: æ£€æŸ¥ Worker Execution

æŸ¥çœ‹åç«¯æ—¥å¿— (Railway Console):

```bash
# æœç´¢ session_id
# æŸ¥æ‰¾ä»¥ä¸‹å…³é”®æ—¥å¿—ï¼š
[Novel Summary] Processing 4 tasks (t1-t4)
[Novel Summary] t3 has output (XXX chars): ...
[Novel Summary] t4 has output (XXX chars): ...
[Novel Summary] Extracted t4 chapter allocations (XXX chars)
```

**å¦‚æœç¼ºå°‘**:
- å¦‚æœæ²¡æœ‰ "t3 has output" â†’ T3 æ²¡æœ‰æ‰§è¡Œæˆ– output ä¸ºç©º
- å¦‚æœæ²¡æœ‰ "t4 has output" â†’ T4 æ²¡æœ‰æ‰§è¡Œæˆ– output ä¸ºç©º
- å¦‚æœæ²¡æœ‰ "Extracted t4 chapter allocations" â†’ T4 output ä¸ºç©º

#### Step 3: æ£€æŸ¥ Envelope Logs

```bash
# åœ¨æœ¬åœ°æˆ–æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cat multi_agent_platform/sessions/{session_id}/logs/envelopes.jsonl | grep "subtask_result"
```

**é¢„æœŸ**:
```json
{"payload": {"subtask_id": "t1", "subtask_title": "Research", ...}}
{"payload": {"subtask_id": "t2", "subtask_title": "äººç‰©è®¾å®š", ...}}
{"payload": {"subtask_id": "t3", "subtask_title": "æƒ…èŠ‚è®¾è®¡", ...}}  // âš ï¸ ç”¨æˆ·è¯´è¿™ä¸ªå¯èƒ½ç¼ºå¤±
{"payload": {"subtask_id": "t4", "subtask_title": "ç« èŠ‚åˆ†é… & å°è¯´æ¦‚è¦æ’°å†™", ...}}
```

### å¯èƒ½çš„æ ¹æœ¬åŸå› 

#### åœºæ™¯ A: T3 çœŸçš„æ²¡æœ‰æ‰§è¡Œ

**åŸå› **:
- Orchestrator å¯èƒ½åœ¨ T2 å®Œæˆåç›´æ¥è·³åˆ°äº† T4
- æˆ–è€… T3 æ‰§è¡Œäº†ä½† result envelope æ²¡æœ‰æ­£ç¡®å‘é€

**ç—‡çŠ¶**:
- Envelope logs ç¼ºå°‘ t3 çš„ subtask_result
- `plan.subtasks[2].status` ä»ç„¶æ˜¯ "pending"

#### åœºæ™¯ B: T4 åªç”Ÿæˆäº† Summary éƒ¨åˆ†ï¼Œæ²¡æœ‰ç”Ÿæˆç« èŠ‚åˆ†é…

**åŸå› **:
- Worker åœ¨æ‰§è¡Œ T4 æ—¶ï¼Œå¯èƒ½åªå†™äº†"å°è¯´æ¦‚è¦"ï¼Œå¿½ç•¥äº†"ç« èŠ‚åˆ†é…"
- Worker prompt å¯èƒ½æ²¡æœ‰æ˜ç¡®è¦æ±‚ç”Ÿæˆä¸¤éƒ¨åˆ†å†…å®¹

**ç—‡çŠ¶**:
- `t4_detailed_chapter_allocations` å­—æ®µå­˜åœ¨ä½†å†…å®¹ä¸å®Œæ•´
- åªæœ‰ summaryï¼Œæ²¡æœ‰ç« èŠ‚åˆ—è¡¨

#### åœºæ™¯ C: å‰ç«¯æ˜¾ç¤ºé€»è¾‘é”™è¯¯

**åŸå› **:
- Worker åˆ—æ²¡æœ‰æ˜¾ç¤ºæ¯ä¸ª subtask çš„ç‹¬ç«‹ output
- åªæ˜¾ç¤ºäº†åˆå¹¶åçš„ `novel_summary_t1_t4`
- ç”¨æˆ·æ— æ³•çœ‹åˆ° T3 å’Œ T4 çš„å…·ä½“å†…å®¹

**ç—‡çŠ¶**:
- åç«¯æ•°æ®æ­£ç¡®ï¼Œä½†å‰ç«¯åªæ˜¾ç¤ºä¸€ä¸ªå¤§çš„ "Novel Summary (t1-t4)" å—
- æ²¡æœ‰æ˜ç¡®çš„ T3 å’Œ T4 å•ç‹¬å±•ç¤ºåŒºåŸŸ

### ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: æ‰‹åŠ¨è§¦å‘ T3 æ‰§è¡Œ

å¦‚æœ T3 è¢«è·³è¿‡ï¼Œå°è¯•ï¼š
1. åœ¨å‰ç«¯ç‚¹å‡» T3 çš„ "Skip" æŒ‰é’®åå†ç‚¹å‡» "Redo"
2. æˆ–ä½¿ç”¨ `/command set_current_subtask` å¼ºåˆ¶è®¾ç½®ä¸º t3

#### æ–¹æ¡ˆ B: æŸ¥çœ‹åŸå§‹ Artifacts

```bash
# æŸ¥çœ‹ t3 å’Œ t4 çš„åŸå§‹è¾“å‡ºæ–‡ä»¶
cat multi_agent_platform/sessions/{session_id}/artifacts/*.md | grep -A 20 "t3\|t4"
```

### æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

#### è§£å†³æ–¹æ¡ˆ 1: ä¿®å¤å‰ç«¯æ˜¾ç¤º - åˆ†ç¦»æ˜¾ç¤º T3 å’Œ T4

**ç›®æ ‡**: Worker åˆ—åº”è¯¥æ˜¾ç¤ºæ¯ä¸ª subtask çš„ç‹¬ç«‹ outputï¼Œè€Œä¸æ˜¯åªæ˜¾ç¤ºåˆå¹¶çš„ summary

**å®æ–½ä½ç½®**: [App.tsx:3840-4163](multi_agent_platform/ui/src/App.tsx#L3840-L4163) - `WorkerColumn` å‡½æ•°

**ä¿®æ”¹æ–¹æ¡ˆ**:

```typescript
function WorkerColumn({ snapshot, ... }: ...) {
  const outputs = [...(snapshot?.worker_outputs ?? [])];
  const novelSummary = ...;
  const t4Details = (snapshot as any)?.state?.extra?.t4_detailed_chapter_allocations || ...;

  // ğŸ†• ä¸º novel mode ç‰¹åˆ«å¤„ç†ï¼šæ˜¾ç¤º t1-t4 çš„ç‹¬ç«‹ outputs
  const isNovelMode = (snapshot as any)?.state?.extra?.novel_mode ||
                      (snapshot as any)?.orchestrator_state?.extra?.novel_mode;

  // ğŸ†• ä» worker_outputs ä¸­æå– t1-t4
  const t1t4Outputs = outputs.filter(o =>
    ['t1', 't2', 't3', 't4'].includes(o.subtask_id)
  );

  return (
    <div>
      {/* æ˜¾ç¤º Novel Summary ä½œä¸ºæ¦‚è§ˆ */}
      {novelSummary && (
        <div>
          <div>Novel Summary (Overview)</div>
          <div>{novelSummary}</div>
        </div>
      )}

      {/* ğŸ†• å•ç‹¬æ˜¾ç¤ºæ¯ä¸ªä»»åŠ¡ */}
      {isNovelMode && t1t4Outputs.length > 0 && (
        <div>
          <div style={{fontWeight: 800}}>Individual Tasks</div>
          {t1t4Outputs.map(out => (
            <div key={out.subtask_id}>
              <div style={{fontWeight: 600}}>
                {out.subtask_id.toUpperCase()}: {subtaskMap.get(out.subtask_id)}
              </div>
              <div>{out.content || out.preview}</div>
            </div>
          ))}
        </div>
      )}

      {/* ğŸ†• ç‰¹åˆ«å¼ºè°ƒ T4 çš„ç« èŠ‚åˆ†é… */}
      {t4Details && (
        <div>
          <div style={{fontWeight: 800}}>T4 Chapter Allocations (Detailed)</div>
          <div style={{whiteSpace: "pre-wrap"}}>{t4Details}</div>
        </div>
      )}

      {/* å…¶ä»– outputs (t5+) */}
      {/* ... ç°æœ‰é€»è¾‘ */}
    </div>
  );
}
```

**é¢„æœŸæ—¶é—´**: 1-2 å°æ—¶
**é£é™©è¯„ä¼°**: ä¸­ï¼ˆéœ€è¦ä»”ç»†æµ‹è¯• novel mode å’Œé novel mode çš„æ˜¾ç¤ºï¼‰

#### è§£å†³æ–¹æ¡ˆ 2: æ·»åŠ  T3 æ‰§è¡ŒéªŒè¯

**ç›®æ ‡**: ç¡®ä¿ T3 ä¸€å®šä¼šè¢«æ‰§è¡Œï¼Œä¸ä¼šè¢«è·³è¿‡

**å®æ–½ä½ç½®**: [run_flow.py](multi_agent_platform/run_flow.py) - Orchestrator logic

**ä¿®æ”¹æ–¹æ¡ˆ**:

```python
def run_next_pending_subtask(self, session_id: str) -> Tuple[str, Plan, OrchestratorState]:
    """Execute next pending subtask."""
    state = self.get_orchestrator_state(session_id)
    plan = self.get_plan(session_id, state.plan_id)

    # ğŸ†• Novel mode: ç¡®ä¿ t1-t4 æŒ‰é¡ºåºæ‰§è¡Œ
    if state.extra.get("novel_mode"):
        required_order = ["t1", "t2", "t3", "t4"]
        for task_id in required_order:
            subtask = next((s for s in plan.subtasks if s.id == task_id), None)
            if subtask and subtask.status == "pending":
                print(f"[Novel Mode] Enforcing sequential execution: running {task_id}")
                return self._run_subtask(session_id, subtask, plan, state)

    # åŸæœ‰é€»è¾‘ï¼šæŸ¥æ‰¾ç¬¬ä¸€ä¸ª pending subtask
    # ...
```

**é¢„æœŸæ—¶é—´**: 30 åˆ†é’Ÿ
**é£é™©è¯„ä¼°**: ä½ï¼ˆåªå½±å“ novel modeï¼‰

#### è§£å†³æ–¹æ¡ˆ 3: æ”¹è¿› T4 Worker Prompt

**ç›®æ ‡**: ç¡®ä¿ Worker åœ¨æ‰§è¡Œ T4 æ—¶ç”Ÿæˆä¸¤éƒ¨åˆ†å†…å®¹

**å®æ–½ä½ç½®**: Worker agent prompt generation

**ä¿®æ”¹æ–¹æ¡ˆ**:

åœ¨ç”Ÿæˆ Worker prompt æ—¶ï¼Œå¯¹ T4 ç‰¹åˆ«å¼ºè°ƒï¼š

```python
if subtask.id == "t4" and state.extra.get("novel_mode"):
    additional_instructions = """
IMPORTANT: This task has TWO parts that MUST both be completed:

1. **Chapter Allocations**: Provide a detailed list of all chapters with:
   - Chapter number and title
   - Main events in each chapter
   - Character appearances
   - Estimated word count

2. **Novel Synopsis**: Write a concise (2-3 paragraph) summary of the entire story.

Output format:
```
## Part 1: Chapter Allocations
[Detailed chapter list here]

## Part 2: Novel Synopsis
[2-3 paragraph summary here]
```
"""
    prompt += additional_instructions
```

**é¢„æœŸæ—¶é—´**: 30 åˆ†é’Ÿ
**é£é™©è¯„ä¼°**: ä½ï¼ˆåªå½±å“ T4ï¼Œä¸å½±å“å…¶ä»–ä»»åŠ¡ï¼‰

### å»ºè®®ä¼˜å…ˆçº§

1. **ç«‹å³**: ä½¿ç”¨è¯Šæ–­æ­¥éª¤ç¡®è®¤é—®é¢˜çš„ç¡®åˆ‡åŸå› ï¼ˆæ˜¯ T3 æ²¡æ‰§è¡Œï¼Ÿè¿˜æ˜¯å‰ç«¯æ˜¾ç¤ºé—®é¢˜ï¼Ÿï¼‰
2. **çŸ­æœŸ**: è§£å†³æ–¹æ¡ˆ 1 - æ”¹è¿›å‰ç«¯æ˜¾ç¤ºï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°æ¯ä¸ªä»»åŠ¡çš„è¾“å‡º
3. **ä¸­æœŸ**: è§£å†³æ–¹æ¡ˆ 2 - æ·»åŠ  T3 æ‰§è¡ŒéªŒè¯
4. **é•¿æœŸ**: è§£å†³æ–¹æ¡ˆ 3 - æ”¹è¿› T4 promptï¼Œç¡®ä¿ç”Ÿæˆå®Œæ•´å†…å®¹

---