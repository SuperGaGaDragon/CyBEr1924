
# Bug æŠ¥å‘Šå’Œè§£å†³æ–¹æ¡ˆ - 2025-12-10

## âŒ CRITICAL: 401 è®¤è¯é—®é¢˜ï¼ˆå†æ¬¡å‡ºç°ï¼‰

### é—®é¢˜ç°è±¡
ç”¨æˆ·åœ¨å·²ç™»å½•çš„æƒ…å†µä¸‹ï¼Œè®¿é—® session é¡µé¢æ—¶æ”¶åˆ° `401 Unauthorized` é”™è¯¯ï¼š
```json
{"detail":"Not authenticated"}
```

**å—å½±å“çš„ Session**: `sess-20251210-204413-3b9a091d`

### æ ¹æœ¬åŸå› åˆ†æ

#### ğŸ” è®¤è¯æµç¨‹å›é¡¾

1. **ç™»å½•æµç¨‹** ([App.tsx:1218-1248](multi_agent_platform/ui/src/App.tsx#L1218-L1248)):
   ```typescript
   // ç™»å½•æˆåŠŸåä¿å­˜ token
   localStorage.setItem("cyber1924_token", resp.access_token);
   setAccessToken(resp.access_token);  // è®¾ç½®å†…å­˜ä¸­çš„ token
   ```

2. **åˆå§‹åŒ–æµç¨‹** ([App.tsx:1023-1033](multi_agent_platform/ui/src/App.tsx#L1023-L1033)):
   ```typescript
   // é¡µé¢åŠ è½½æ—¶ä» localStorage æ¢å¤ token
   useEffect(() => {
     const savedToken = localStorage.getItem("cyber1924_token");
     if (savedToken) {
       setAccessToken(savedToken);  // âœ… æ¢å¤åˆ°å†…å­˜
       setAuth((prev) => ({ ...prev, accessToken: savedToken, isLoggedIn: true }));
     }
   }, []);
   ```

3. **è¯·æ±‚å‘é€** ([api.ts:144-146](multi_agent_platform/ui/src/api.ts#L144-L146)):
   ```typescript
   // æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¸¦ä¸Š Authorization header
   if (accessToken) {
     headers["Authorization"] = `Bearer ${accessToken}`;
   }
   ```

4. **åç«¯éªŒè¯** ([api.py:109-128](api.py#L109-L128)):
   ```python
   def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security)):
       if credentials is None:
           raise HTTPException(status_code=401, detail="Not authenticated")

       token = credentials.credentials
       user_id = decode_access_token(token)
       if not user_id:
           raise HTTPException(status_code=401, detail="Invalid or expired token")
   ```

#### ğŸ› å¯èƒ½çš„å¤±è´¥åœºæ™¯

**åœºæ™¯ A: Token è¿‡æœŸ**
- JWT token æœ‰æœ‰æ•ˆæœŸé™åˆ¶
- å¦‚æœç”¨æˆ·ç™»å½•åå¾ˆé•¿æ—¶é—´ï¼ˆä¾‹å¦‚å‡ å¤©ï¼‰å†è®¿é—®ï¼Œtoken å¯èƒ½å·²è¿‡æœŸ
- **ç—‡çŠ¶**: `decode_access_token()` è¿”å› `None`ï¼Œåç«¯è¿”å› "Invalid or expired token"

**åœºæ™¯ B: Token æœªæ­£ç¡®æ¢å¤**
- é¡µé¢åˆ·æ–°æ—¶ `useEffect` æœªæ­£ç¡®æ‰§è¡Œ
- `setAccessToken()` è°ƒç”¨å¤±è´¥æˆ–å»¶è¿Ÿ
- **ç—‡çŠ¶**: è¯·æ±‚æ—¶ `accessToken` ä¸º `null`ï¼Œä¸å¸¦ Authorization headerï¼Œåç«¯è¿”å› "Not authenticated"

**åœºæ™¯ C: è·¨åŸŸ Token ä¸¢å¤±**
- å¦‚æœä»ä¸åŒåŸŸåè®¿é—®ï¼ˆä¾‹å¦‚ Railway é¢„è§ˆ URLï¼‰
- localStorage å¯èƒ½æ— æ³•è®¿é—®ä¹‹å‰çš„ token
- **ç—‡çŠ¶**: ç”¨æˆ·çœ‹èµ·æ¥å·²ç™»å½•ï¼Œä½†å®é™…ä¸Š token å·²ä¸¢å¤±

**åœºæ™¯ D: Token æ ¼å¼é”™è¯¯**
- Token åœ¨å­˜å‚¨/è¯»å–è¿‡ç¨‹ä¸­è¢«æŸå
- åŒ…å«é¢å¤–çš„ç©ºæ ¼æˆ–æ¢è¡Œç¬¦
- **ç—‡çŠ¶**: åç«¯æ— æ³•è§£ç  token

### è¯Šæ–­æ­¥éª¤

#### Step 1: æ£€æŸ¥æµè§ˆå™¨ DevTools

1. **æ‰“å¼€ Console æ ‡ç­¾**ï¼Œåˆ·æ–°é¡µé¢ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯
2. **æ‰“å¼€ Application æ ‡ç­¾** â†’ Local Storage:
   - æ£€æŸ¥ `cyber1924_token` æ˜¯å¦å­˜åœ¨
   - å¤åˆ¶ token å€¼ï¼Œæ£€æŸ¥æ˜¯å¦å®Œæ•´ï¼ˆJWT æ ¼å¼ï¼š`xxx.yyy.zzz`ï¼‰
3. **æ‰“å¼€ Network æ ‡ç­¾**ï¼Œå°è¯•è®¿é—® session:
   - æ‰¾åˆ°å¤±è´¥çš„ `/sessions/sess-xxx` è¯·æ±‚
   - **æŸ¥çœ‹ Request Headers**:
     - æ˜¯å¦æœ‰ `Authorization: Bearer xxx` headerï¼Ÿ
     - Token å€¼æ˜¯å¦ä¸ localStorage ä¸­ä¸€è‡´ï¼Ÿ
   - **æŸ¥çœ‹ Response**:
     - è¿”å›çš„é”™è¯¯æ˜¯ "Not authenticated" è¿˜æ˜¯ "Invalid or expired token"ï¼Ÿ

#### Step 2: éªŒè¯ Token æœ‰æ•ˆæ€§

æ‰“å¼€æµè§ˆå™¨ Consoleï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š

```javascript
// 1. æ£€æŸ¥ localStorage
console.log("Token in localStorage:", localStorage.getItem("cyber1924_token"));

// 2. æ‰‹åŠ¨æµ‹è¯• API è°ƒç”¨
const token = localStorage.getItem("cyber1924_token");
fetch("https://cyber1924-production.up.railway.app/sessions", {
  headers: {
    "Authorization": `Bearer ${token}`
  }
})
.then(r => r.json())
.then(data => console.log("API Response:", data))
.catch(err => console.error("API Error:", err));
```

**é¢„æœŸç»“æœ**:
- å¦‚æœ token æœ‰æ•ˆ â†’ è¿”å› session åˆ—è¡¨
- å¦‚æœ token è¿‡æœŸ â†’ `{"detail":"Invalid or expired token"}`
- å¦‚æœ token ä¸¢å¤± â†’ `{"detail":"Not authenticated"}`

#### Step 3: æ£€æŸ¥åç«¯æ—¥å¿—

åœ¨ Railway æ§åˆ¶å°æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—ï¼š
```bash
# æœç´¢è®¤è¯ç›¸å…³çš„é”™è¯¯
# æŸ¥æ‰¾ session_id: sess-20251210-204413-3b9a091d
# æŸ¥æ‰¾ç”¨æˆ· ID å’Œ token è§£ç å¤±è´¥çš„è®°å½•
```

### ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ A: é‡æ–°ç™»å½•**
1. ç‚¹å‡» "Logout" æŒ‰é’®
2. é‡æ–°è¾“å…¥é‚®ç®±å’Œå¯†ç ç™»å½•
3. å°è¯•è®¿é—®ä¹‹å‰å¤±è´¥çš„ session

**æ–¹æ¡ˆ B: æ¸…é™¤ localStorage**
```javascript
// åœ¨æµè§ˆå™¨ Console æ‰§è¡Œ
localStorage.clear();
location.reload();
```

### æ ¹æœ¬è§£å†³æ–¹æ¡ˆ

#### è§£å†³æ–¹æ¡ˆ 1: æ·»åŠ  Token åˆ·æ–°æœºåˆ¶

**ç›®æ ‡**: Token è¿‡æœŸå‰è‡ªåŠ¨åˆ·æ–°

**å®æ–½ä½ç½®**: [api.py](api.py)

æ·»åŠ  `/auth/refresh` endpoint:
```python
@app.post("/auth/refresh")
def refresh_token(current_user = Depends(get_current_user)) -> AuthResponse:
    """
    åˆ·æ–° access tokenã€‚
    éœ€è¦æä¾›æœ‰æ•ˆçš„å½“å‰ tokenã€‚
    """
    new_token = create_access_token(current_user.id)
    return AuthResponse(
        message="Token refreshed",
        access_token=new_token,
        token_type="bearer"
    )
```

å‰ç«¯åœ¨æ£€æµ‹åˆ° 401 é”™è¯¯æ—¶è‡ªåŠ¨å°è¯•åˆ·æ–°:
```typescript
// api.ts
async function request<T>(path: string, options: RequestInit = {}): Promise<T> {
  const resp = await fetch(`${API_BASE}${path}`, { ...options, headers });

  if (resp.status === 401 && path !== "/auth/refresh") {
    // Token å¯èƒ½è¿‡æœŸï¼Œå°è¯•åˆ·æ–°
    try {
      const refreshResp = await fetch(`${API_BASE}/auth/refresh`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${accessToken}` }
      });
      if (refreshResp.ok) {
        const data = await refreshResp.json();
        setAccessToken(data.access_token);
        localStorage.setItem("cyber1924_token", data.access_token);
        // é‡è¯•åŸå§‹è¯·æ±‚
        return request<T>(path, options);
      }
    } catch {}
    // åˆ·æ–°å¤±è´¥ï¼ŒæŠ›å‡º 401 é”™è¯¯
  }

  // ... ç°æœ‰é”™è¯¯å¤„ç†é€»è¾‘
}
```

**é¢„æœŸæ—¶é—´**: 1-2 å°æ—¶
**é£é™©è¯„ä¼°**: ä¸­ï¼ˆéœ€è¦ä»”ç»†æµ‹è¯•åˆ·æ–°é€»è¾‘ï¼Œé¿å…æ— é™å¾ªç¯ï¼‰

#### è§£å†³æ–¹æ¡ˆ 2: å»¶é•¿ Token æœ‰æ•ˆæœŸ

**ç›®æ ‡**: è®© token æœ‰æ•ˆæœŸæ›´é•¿ï¼Œå‡å°‘è¿‡æœŸé¢‘ç‡

**å®æ–½ä½ç½®**: [api.py](api.py) - `create_access_token()` å‡½æ•°

```python
def create_access_token(user_id: int) -> str:
    # ä» 1 å°æ—¶å»¶é•¿åˆ° 7 å¤©
    expire = datetime.utcnow() + timedelta(days=7)
    payload = {
        "sub": str(user_id),
        "exp": expire,
    }
    return jwt.encode(payload, JWT_SECRET_KEY, algorithm="HS256")
```

**ä¼˜ç‚¹**: ç®€å•ï¼Œç«‹å³ç”Ÿæ•ˆ
**ç¼ºç‚¹**: å®‰å…¨æ€§é™ä½ï¼ˆtoken æ³„éœ²åæœ‰æ•ˆæœŸæ›´é•¿ï¼‰

**é¢„æœŸæ—¶é—´**: 5 åˆ†é’Ÿ
**é£é™©è¯„ä¼°**: ä½ï¼ˆçº¯é…ç½®ä¿®æ”¹ï¼‰

#### è§£å†³æ–¹æ¡ˆ 3: æ·»åŠ è¯¦ç»†çš„è®¤è¯é”™è¯¯æ—¥å¿—

**ç›®æ ‡**: å¸®åŠ©è¯Šæ–­æœªæ¥çš„è®¤è¯é—®é¢˜

**å®æ–½ä½ç½®**: [api.py:109-128](api.py#L109-L128)

```python
def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
):
    if credentials is None:
        print("[AUTH] No credentials provided")
        raise HTTPException(status_code=401, detail="Not authenticated")

    token = credentials.credentials
    print(f"[AUTH] Attempting to decode token: {token[:20]}...")  # åªæ‰“å°å‰20ä¸ªå­—ç¬¦

    user_id = decode_access_token(token)
    if not user_id:
        print(f"[AUTH] Token decode failed or expired")
        raise HTTPException(status_code=401, detail="Invalid or expired token")

    user = get_user_by_id(user_id)
    if not user:
        print(f"[AUTH] User {user_id} not found in database")
        raise HTTPException(status_code=401, detail="User not found")

    print(f"[AUTH] âœ“ User {user.id} authenticated successfully")
    return user
```

**é¢„æœŸæ—¶é—´**: 15 åˆ†é’Ÿ
**é£é™©è¯„ä¼°**: æä½ï¼ˆåªæ·»åŠ æ—¥å¿—ï¼‰

### å»ºè®®ä¼˜å…ˆçº§

1. **ç«‹å³**: è§£å†³æ–¹æ¡ˆ 3 - æ·»åŠ è®¤è¯æ—¥å¿—ï¼ˆå¸®åŠ©è¯Šæ–­å½“å‰é—®é¢˜ï¼‰
2. **çŸ­æœŸ**: è§£å†³æ–¹æ¡ˆ 2 - å»¶é•¿ token æœ‰æ•ˆæœŸï¼ˆå¿«é€Ÿä¿®å¤ï¼‰
3. **é•¿æœŸ**: è§£å†³æ–¹æ¡ˆ 1 - å®ç° token åˆ·æ–°æœºåˆ¶ï¼ˆæœ€ä½³å®è·µï¼‰

---

## å½“å‰çŠ¶æ€æ¦‚è§ˆ

### å·²ç¡®è®¤çš„é—®é¢˜
- âŒ **P0 - 401 è®¤è¯é”™è¯¯**: ç”¨æˆ·ç™»å½•åä»ç„¶æ”¶åˆ° "Not authenticated" é”™è¯¯
- Reviewer ä¸æ»šåŠ¨
- task 3åŠ è½½ä¸å‡ºæ¥ï¼Œå¡ç€ä¸æ˜¾ç¤º
- task 3 ä¸ä¼šæ‰§è¡Œã€‚
- è·³è¿‡task 3ï¼Œç›´æ¥ç”Ÿæˆtask1-4 summary
- task 4 åªæœ‰task 1-4 summaryï¼Œä¸æ‰§è¡Œç« èŠ‚åˆ†é…
- ä¸€æ—¦è¿›å…¥è¿™ä¸ªpageï¼Œreviewerå°±ä¸èƒ½æ»šåŠ¨

### ä¸€äº›å»ºè®®ï¼ˆå¯èƒ½ä¸å¯¹ï¼‰
- å»ºè®®å¼ºåˆ¶worker çš„outputå°±æ˜¯task 1ï¼Œtask2ï¼Œtask3ï¼Œtask4. è¿™ä¸ªsummaryé™„å±äºtask4ï¼Œä¸è¦å•ç‹¬å¼„ä¸€ä¸ªå•ç‹¬çš„å‡ºæ¥ï¼Œä¼šconfuseã€‚