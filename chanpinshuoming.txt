项目目标（成品长什么样）
要做的是一个多智能体协作写作/任务平台，核心构成仍然是 Planner/Worker/Coordinator 三个角色（左中右三栏 UI），
支持可执行计划、子任务执行与协调审核、用户随时提问/修改，最终能承载长文/复杂项目。

## 当前项目结构
```
multi_agent_platform/
  ├─ run_flow.py             可复用的 Orchestrator（init_session/run_next/run_all/answer_user_question ）
  ├─ plan_model.py           Plan/Subtask dataclass + Plan.from_outline/to_json/to_brief_text
  ├─ session_store.py        ArtifactStore + ArtifactRef + logs/sessions + session_index
  ├─ message_bus.py          统一构造 protocol.Envelope + ProtocolValidator + log_user_command
  ├─ agent_runner.py         OpenAI Agent + mock fallback (planner/worker echo, coordinator ACCEPT)
  ├─ interactive_session*.py 多种 CLI 入口，调用 Orch.run_next/run_all/answer_user_question，记录 user_command
  ├─ session_state.py        OrchestratorState + helpers for persistence
  ├─ interactive_coordinator.py、execute_command 等：后续 FastAPI/API 集成用
  ├─ run_example.py          旧入口，构造 store+bus，运行 run_all 演示完整流程
docs/、QUICK_START.md、SESSION_RECOVERY_README.md 等文档给出操作步骤和恢复说明
src/protocol.py             JSON Schema + Envelope/ProtocolValidator/BUILD helpers
tests like test_unified_flow.py、test_recovery.py、validate_mvp.py、test_long_form_writing.py cover state/API expectations
```

## 功能细节（按文件）
- `multi_agent_platform/run_flow.py`：
  * 配置化 Orchestrator（可替换模型），负责 planner 生成计划、worker 执行、coordinator 决策，循环直到所有 subtask 完成；
  * `init_session` 创建 artifact/session，保存 orchestrator_state.json；
  * `run_next_pending_subtask` 支持 interactive 模式 `user_feedback` 和 `answer_user_question` 供右侧 coordinator QA；
  * `run_all` 简化一键跑完逻辑，结果包含 plan/outline/state。
- `multi_agent_platform/plan_model.py`：从 outline 解析出有序 `Subtask` 列表，使用 `Plan.to_json()`/`to_brief_text()` 支持序列化和 coordinator 上下文。
- `multi_agent_platform/session_store.py`：统一管理 `sessions/<id>/artifacts` + logs + `session_index.json`，`ArtifactStore.save_artifact` 返回可插入协议的 `ArtifactRef`。
- `multi_agent_platform/message_bus.py`：调用 `src.protocol.build_envelope` + `ProtocolValidator`，并提供 `send`/`build_envelope`/`append_envelope`/`log_user_command`，生成 `logs/envelopes.jsonl`。
- `multi_agent_platform/agent_runner.py`：封装 OpenAI 交互（系统+用户消息），`OPENAI_API_KEY` 为空时按 planner/worker/coordinator 简要逻辑返回可控模拟内容。
- `multi_agent_platform/interactive_session*.py`：交互式 CLI（两个版本/统一版本）支持 `/plan` `/next` `/all` `自然语言`，所有用户输入写入 `user_command` envelope；`interactive_session_unified.py` 还调用 `execute_command`/`OrchestratorState` 和 coordinator 对话结合。
- `multi_agent_platform/session_state.py`：`OrchestratorState` dataclass，读写 `orchestrator_state.json`，被 CLI、API、测试共享。
- `multi_agent_platform/interactive_coordinator.py` + `execute_command`：为 FastAPI 提供 `/command` 类型的统一处理，利用 `Orchestrator.execute_command` 反向驱动 `run_next_pending_subtask`。
- `multi_agent_platform/run_example.py`：维持旧入口，构造 `ArtifactStore` + `MessageBus`，通过 `Orchestrator.run_all(topic)` 跑一次 demo；打印 `plan`/`outline` artifact 路径。
- `multi_agent_platform/interactive_session.py` / `_unified.py` / `_v2.py`：可恢复/恢复模式、`message_bus.log_user_command` + CLI loops、`execute_command` 结果应用（plan+state update）、`answer_user_question` 用 plan 生成上下文并调用 coordinator。
- `src/protocol.py`：定义众多 `PayloadType`（`plan_created`/`subtask_result`/`coord_decision`/`user_command` 等），`Envelope` + `ProtocolValidator` + `build_envelope`，`PAYLOAD_SCHEMAS` 明确每种 envelope 的 schema。
- top-level docs（ARCHITECTURE_V2/IMPLEMENTATION_SUMMARY/QUICK_START/SESSION_RECOVERY_README）定级系统目标，指导开发与恢复。
- tests/scripts (`validate_mvp.py`, `test_recovery.py`, `test_unified_flow.py`, `test_long_form_writing.py`) 确保状态持久化、execute_command、session index、answer_user_question 上下文、新 payload 方案、long-form writing 指南。

## 当前可交付结果（对 ChatGPT 汇报）
1. `python3 -m multi_agent_platform.run_example` 演示 Planner→ Worker→ Coordinator 完整流程（在没有 API key 时使用内置 mock，生成 sessions/artifacts/logs）。
2. `python3 -m multi_agent_platform.interactive_session[_unified|_v2]` 提供命令式 CLI，支持 `/plan` `/next` `/all` 直到 plan 完成，并把自然语言交给 coordinator 解释。
3. 所有 `MessageBus` 事件都写入 `multi_agent_platform/sessions/<id>/logs/envelopes.jsonl` 以便后续 UI 回放，`user_command` 也记录。
4. Plan/State/Logs 均持久化，下次可恢复（`SessionStore` + `OrchestratorState` + `session_index`），并可通过 `validate_mvp.py`/`test_recovery.py` 验证。
5. FastAPI skeleton (`api.py`) + `interactive_coordinator`/`execute_command` 已具备 session 创建、命令执行、状态查询基础，可接 Web UI。
